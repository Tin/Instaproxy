<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="js/mustache.js"></script>
  <title>Instagr.am of xxx</title>
  <textarea id="template" style="display: none;">
<ul>
  {{#timeline}}
    {{#user}}
      <dt>{{full_name}}({{username}})</dt>
      <dd>
        <img width="48" height="48" src="{{profile_pic_url}}" />
      </dd>
    {{/user}}
    {{#pictures}}
      <li>
        {{#prefered_version}}
          <img class="prefered-version" src="{{url}}" />
        {{/prefered_version}}
        <ul class="image-versions" style="display: none">
          {{#image_versions}}
            <img width="{{width}}" height="{{height}}" src="{{url}}" />
          {{/image_versions}}
        </ul>
        <p class="likers">
          {{#likers}}
            <span data-pk="{{pk}}" data-pic="{{profile_pic_url}}" data-username="{{username}}">{{full_name}}</span>
          {{/likers}}
          likes it
        </p>
        <ul class="comments">
        {{#comments}}
            <li data-type="{{content_type}}" data-createdat="{{created_at}}">{{#user}}<span data-pk="{{pk}}" data-pic="{{profile_pic_url}}" data-username="{{username}}" data-fullname="{{full_name}}">{{username}}</span>{{/user}}: {{text}}</li>
        {{/comments}}
        </ul>
      </li>
    {{/pictures}}
  {{/timeline}}
</ul>
  </textarea>
  <script type="text/javascript" charset="utf-8">
  var DOMAIN = window.location && window.location.host ? window.location.host : 'instagram.diamondtin.com';
  var template = $('#template').val();

  var showTimeline = function(data) {
    console.log(data)
    for (var pic_index = 0; pic_index < data.pictures.length; pic_index ++) {
      var item = data.pictures[pic_index];
      for (var index = 0; index < item.image_versions.length; index++) {
        if (item.image_versions[index].type == 5) {
          item.prefered_version = item.image_versions[index];
        }
      }
    }
    var html = Mustache.to_html(template, {'timeline': data});
    $('#timeline').html(html);
  };

  function getQueryParams() {
    var pairs = window.location.search.replace(/^\?/, '').split('&');
    var dict = {}
    for (var index = 0; index < pairs.length; index++) {
      var pair = pairs[index];
      var parts = pair.split('=');
      if (parts.length >= 1) {
        dict[parts[0]] = parts[1];
      }
    }
    return dict;
  }

  $(function(){
    var params = getQueryParams();
    var id = params['id'] ? params.id : 88156;
    var count = $('#timeline').data('count');
    $.getJSON('http://' + DOMAIN + '/api/timeline/' + id + '?count=' + count + '&callback=?', showTimeline);
  });
  </script>
</head>
<body>
<div id="timeline" data-count="10">
</div>
</body>
</html>
